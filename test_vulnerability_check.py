#!/usr/bin/env python3
"""
Test script for OpenSSL Vulnerability Checker

This script tests the vulnerability checking functionality by querying
various OpenSSL versions to demonstrate how the checker works.
"""

import sys
import os

# Add the current directory to the path to import from the main script
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

try:
    from openssl_agent_all_unix_and_windows import VulnerabilityChecker
    print("✓ Successfully imported VulnerabilityChecker\n")
except ImportError as e:
    print(f"❌ Failed to import VulnerabilityChecker: {e}")
    sys.exit(1)

def test_version(version: str):
    """Test vulnerability check for a specific version."""
    print(f"\n{'='*70}")
    print(f"Testing OpenSSL version: {version}")
    print(f"{'='*70}\n")
    
    checker = VulnerabilityChecker(version)
    result = checker.check_vulnerabilities()
    
    if result.get('error'):
        print(f"⚠ Error during check: {result['error']}")
        return
    
    if result['found']:
        checker.display_vulnerabilities(result)
        
        # Determine if this version would be blocked
        if result['critical_count'] > 0 or result['high_count'] > 0:
            print(f"\n❌ This version would be BLOCKED from installation")
            print(f"   ({result['critical_count']} CRITICAL, {result['high_count']} HIGH)")
        else:
            print(f"\n⚠ This version would show a WARNING but allow installation")
            print(f"   (No critical or high severity vulnerabilities)")
    else:
        print(f"✓ No vulnerabilities found - this version is safe to install")
    
    return result

def main():
    """Run tests on various OpenSSL versions."""
    print("="*70)
    print("OpenSSL Vulnerability Checker - Test Suite")
    print("="*70)
    print("\nThis script will test the vulnerability checker with various")
    print("OpenSSL versions to demonstrate its functionality.\n")
    
    # Test versions - mix of old (likely vulnerable) and newer versions
    test_versions = [
        "3.0.0",   # Older version, likely has vulnerabilities
        "3.0.8",   # Intermediate version
        "3.1.0",   # Another version to test
        "3.2.0",   # Newer version
        "1.1.1",   # Old 1.1.1 branch
    ]
    
    results = {}
    
    for version in test_versions:
        try:
            result = test_version(version)
            results[version] = result
        except KeyboardInterrupt:
            print("\n\nTest interrupted by user.")
            sys.exit(0)
        except Exception as e:
            print(f"\n❌ Unexpected error testing {version}: {e}")
            results[version] = {'error': str(e)}
    
    # Summary
    print(f"\n\n{'='*70}")
    print("SUMMARY")
    print(f"{'='*70}\n")
    
    for version, result in results.items():
        if result.get('error'):
            status = f"⚠ ERROR: {result['error']}"
        elif result.get('found'):
            if result['critical_count'] > 0 or result['high_count'] > 0:
                status = f"❌ BLOCKED ({result['count']} vulns: {result['critical_count']} CRIT, {result['high_count']} HIGH)"
            else:
                status = f"⚠ WARNING ({result['count']} vulns: low/medium severity)"
        else:
            status = "✓ SAFE (no vulnerabilities)"
        
        print(f"  {version:10s} - {status}")
    
    print(f"\n{'='*70}")
    print("Test complete!")
    print(f"{'='*70}\n")

if __name__ == '__main__':
    main()
